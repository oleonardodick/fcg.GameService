name: CD
on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  contents: read        
  id-token: write       
  actions: read         
  checks: read         
  deployments: write    
  packages: write       

jobs:

  pushECR:
    name: Build and Push to ECR
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    uses: ./.github/workflows/build-push-ecr.yml
    secrets: inherit

  # Exemplo futuro de deploy no EKS:
  # deployEKS:
  #   name: Deploy to EKS
  #   needs: pushECR
  #   uses: ./.github/workflows/deploy-eks.yml
  #   secrets: inherit


  # jobs comentados pois não será feito o deploy no ACA.
  # mantido no código apenas para consulta futura
  # ensureResources:
  #   if: ${{ github.event.workflow_run.conclusion == 'success' }}
  #   uses: ./.github/workflows/ensure-azure-resources.yml
  #   secrets: inherit

  # pushACR:
  #   needs: ensureResources
  #   uses: ./.github/workflows/build-push-acr.yml
  #   secrets: inherit

  # deployACA:
  #   needs: pushACR
  #   uses: ./.github/workflows/deploy-aca.yml
  #   secrets: inherit
    
